# Python PostgreSQL Performance Tools

Python-порт [Heroku PG Extras](https://github.com/heroku/heroku-pg-extras) с некоторыми дополнениями и улучшениями. Цель этого проекта - предоставить мощные возможности по изучению базы данных PostgreSQL для приложений на Python, которые не используют плагин Heroku PostgreSQL.

С помощью запросов можно получить информацию об экземпляре Postgres, которая может быть полезна при анализе проблем с производительностью. Сюда входит информация о блокировках, использовании индексов, коэффициентах попадания в буферный кэш и вакуумная статистика.

## Требования

Python 3.8+

## Установка

<div class="termy">

```console
$ pip install pgperf
---> 100%
Successfully installed pgperf
```

</div>



Некоторые запросы (например, `calls` и `outliers`) требуют включения расширения [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html).

Вы можете проверить, включено ли оно в вашей базе данных, выполнив команду:

<div class="termy">

```console
❯ pgperf server additional extensions
```
</div>

В выводе вы должны увидеть аналогичную строку:

<div class="termy">

```console
| pg_stat_statements  | 1.7  | 1.7 | track execution statistics of all SQL statements executed |
```

</div>

## Использование

Пожалуйста, отредактируйте конфигурацию в вашем домашнем каталоге, имя файла - .pgperf.yml

```yaml
prod:
  db:
    server: 127.0.0.1
    port: 5432
    db: prod_db_name
    user: prod_db_user
    password: prod_db_pass
```

Вы можете запускать любые команды и видеть все доступные команды:
<div class="termy">

```console
❯ pgperf --help
Использование: pgperf [OPTIONS] COMMAND [ARGS]...                                     
                                                                               
 Python-порт [Heroku PG Extras](https://github.com/heroku/heroku-pg-extras) 
 с несколькими дополнениями и улучшениями.                                      
 Цель этого проекта - предоставить мощные возможности работы с базой данных PostgreSQL  
 для приложений на Python, которые не используют плагин Heroku PostgreSQL.     
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --conf                      TEXT                                            │
│ --install-completion Завершение установки для текущей оболочки. │
│ --show-completion Показать завершение для текущей оболочки, чтобы │
│ скопировать его или настроить установку.    │
│ --help Вывести сообщение и выйти.               │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ all-locks Перечислите все текущие блокировки в вашей базе данных │
│ блокировка Получите все утверждения, которые в настоящее время удерживают блокировки │
│ в вашей базе данных │
│ buffercache-stats Получить всю статистику буферного кэша │
│ buffercache-usage Получить все данные об использовании буферного кэша │
│ cache-hits Получить все хиты кэша │
│ вызовы Получить запросы, которые имеют наибольшую частоту │
│ выполнения │ │
│ calls-legacy Получить запросы, которые имеют наибольшую частоту │ │ выполнения.
│ выполнения │
│ Index Index Informations │
│ locks Запросы с активными эксклюзивными блокировками │
│ long-running-queries Все запросы длительностью более пяти минут по убыванию │
│ продолжительности │
│ outliers Запросы, имеющие наибольшее время выполнения в совокупности │
│ server Информация о сервере │
│ таблица Информация о таблице │
│ версия                                                                     │
╰─────────────────────────────────────────────────────────────────────────────╯

```
</div>


### Информация о сервере PostgreSQL
<div class="termy">

```console
❯ pgperf server --help
                                                                               
 Использование: pgperf server [OPTIONS] COMMAND [ARGS]...                              
                                                                               
 Информация о сервере                                                           
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --verbose    --no-verbose          [default: no-verbose]                    │
│ --debug      --no-debug            [default: no-debug]                      │
│ --conf                       TEXT                                           │
│ --help                             Show this message and exit.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ active-conections Список всех активных соединений в данный момент в вашей │
│ базе данных │
│ дополнительные Дополнительные поставляемые модули │
│ configuration Информация о конфигурации сервера │
│ db-settings Получить настройки БД │
│ kill-all Убить все активные соединения с базой данных │
│ ssl-used Проверьте, используется ли SSL-соединение │
│ stats Сборщик статистики. Сборщик статистики PostgreSQL │
│ коллектор - это подсистема, которая поддерживает сбор и │
│ отчетность об активности сервера.          │
│ vacuum-stats Мертвые строки и ожидается ли автоматический вакуум │
│ быть вызван                                             │
╰─────────────────────────────────────────────────────────────────────────────╯

``` 
</div>

#### Дополнительная информация о сервере PostgreSQL

<div class="termy">

```console
❯ pgperf server additional --help
                                                                               
 Использование: pgperf server additional [OPTIONS] COMMAND [ARGS]...                   
                                                                               
 Дополнительные модули, входящие в комплект поставки                                                   
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --verbose --no-verbose [по умолчанию: no-verbose] │
│ --debug --no-debug [по умолчанию: no-debug] │
│ --conf TEXT │
│ --help Вывести сообщение и выйти.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ add-all-recommended-extensions Добавление расширений [sslinfo, pg_buffercache, │
│ pg_stat_statements] к вашей базе данных.       │
│ расширения Получение доступных и установленных расширений      │
╰─────────────────────────────────────────────────────────────────────────────╯
``` 
</div>

#### Конфигурация сервера PostgreSQL 

<div class="termy">

```console
❯ pgperf server configuration --help
                                                                               
 Использование: pgperf server configuration [OPTIONS] COMMAND [ARGS]...                
                                                                               
 Информация о конфигурации сервера                                              
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --verbose --no-verbose [по умолчанию: no-verbose] │
│ --debug --no-debug [по умолчанию: no-debug] │
│ --conf TEXT │
│ --help Вывести сообщение и выйти.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ authentication Показать конфигурацию аутентификации │
│ connection-settings Показать конфигурацию параметров подключения │
│ disk Show Kernel Resource Usage configuration │
│ file-locations Показать конфигурацию File Locations │
│ kernel Show Kernel configuration │
│ memory Show Memory configuration │
│ replication Replication Server Replication information │
│ show-all Показать конфигурацию всех серверов │
│ ssl Показать конфигурацию аутентификации │
│ vacuum Показать конфигурацию вакуумной задержки на основе затрат │ │ │ vacuum
│ writer Показать конфигурацию Background Writer               │
╰─────────────────────────────────────────────────────────────────────────────╯
``` 
</div>

### Статистика сервера PostgreSQL

<div class="termy">

```console
❯ pgperf server stats --help
                                                                               
 Использование: pgperf server stats [OPTIONS] COMMAND [ARGS]...                        
                                                                               
 Сборщик статистики. Сборщик статистики PostgreSQL - это подсистема.    
 которая поддерживает сбор и предоставление информации об активности сервера.  
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --verbose --no-verbose [по умолчанию: no-verbose] │
│ --debug --no-debug [по умолчанию: no-debug] │
│ --conf TEXT │
│ --help Вывести сообщение и выйти.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ собранные Собранные представления статистики │
│ dinamic Динамические представления статистики                              │
╰─────────────────────────────────────────────────────────────────────────────╯
``` 
</div>

### Сбор статистики сервера PostgreSQL

<div class="termy">

```console
❯ pgperf server stats collected --help
                                                                               
 Использование: pgperf server stats collected [OPTIONS] COMMAND [ARGS]...              
                                                                               
 Представления собранной статистики                                                    
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --verbose --no-verbose [по умолчанию: no-verbose] │
│ --debug --no-debug [по умолчанию: no-debug] │
│ --conf TEXT │
│ --help Вывести сообщение и выйти.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ all-indexes Одна строка для каждого индекса в текущей базе данных, │
│ показывающая статистику обращений к конкретному │
│ индексу. Подробности см. в разделе pg_stat_all_indexes.            │
│ (Совместимо с PostgresSQL >= 11.0 ) │ │
│ all-tables Одна строка для каждой таблицы в текущей базе данных, │
│ показывающая статистику обращений к конкретной │
│ таблице.  Подробности см. в разделе pg_stat_all_tables.            │
│ (Совместимо с PostgresSQL >= 11.0 ) │ │
│ архиватор Только одна строка, показывающая статистику о работе процесса WAL │ │ архиватора.
│ деятельности процесса архиватора.  См. pg_stat_archiver для │
│ подробностей. ( Совместимо с PostgresSQL >= 11.0 ) │ │
│ bgwriter Только одна строка, показывающая статистику о работе фонового │
│ активности процесса записи.  См. pg_stat_bgwriter для │
│ подробностей. ( Совместимо с PostgresSQL >= 11.0 ) │ │
│ базы данных Одна строка на базу данных, показывающая общую │ │ статистику базы данных.
│ статистику.  Подробности см. в pg_stat_database.         │
│ (Совместимо с PostgresSQL >= 11.0 ) │ │
│ Конфликты в базе данных Одна строка на базу данных, показывающая статистику по всей базе данных.
│ об отмене запросов из-за конфликтов с восстановлением на │
│ резервных серверах.  См. pg_stat_database_conflicts для │
│ подробности. (Совместимо с PostgresSQL >= 11.0 ) │ │
│ io-all-indexes Одна строка для каждого индекса в текущей базе данных, │
│ показывающая статистику ввода-вывода по данному конкретному индексу.  │
│ Подробнее см. в разделе pg_statio_all_indexes. (Совместимо │
│ с PostgresSQL >= 11.0 )                             │
│ io-all-sequences Одна строка для каждой последовательности в текущей базе данных, │
│ показывающая статистику ввода-вывода по данной конкретной │
│ последовательности. Подробности см. в разделе pg_statio_all_sequences.    │
│ (Совместимо с PostgresSQL >= 11.0 ) │ │
│ io-all-tables Одна строка для каждой таблицы в текущей базе данных, │
│ показывающая статистику ввода-вывода для данной конкретной таблицы.   │
│ Подробнее см. в разделе pg_statio_all_tables. (Совместимо с │
│ PostgresSQL >= 11.0 ) │ │
│ io-sys-indexes То же, что и pg_statio_all_indexes, за исключением того, что отображаются только │ │ индексы на системных таблицах.
│ индексов в системных таблицах. (Совместимо с │
│ PostgresSQL >= 11.0 ) │
│ io-sys-sequences Аналогично pg_statio_all_sequences, за исключением того, что показываются только │ │ системные последовательности.
│ системные последовательности. (В настоящее время системные │
│ последовательностей не определено, поэтому это представление всегда пустое).  │
│ (Совместимо с PostgresSQL >= 11.0 ) │ │
│ io-sys-tables Аналогично pg_statio_all_tables, за исключением того, что отображаются только системные │ │ таблицы.
│ таблицы. (Совместимо с PostgresSQL >= 11.0 │
│ )                                                      │
│ io-user-indexes Аналогично pg_statio_all_indexes, за исключением того, что показываются только │ │ индексы на пользовательских таблицах.
│ индексов на пользовательских таблицах. (Совместимо с │
│ PostgresSQL >= 11.0 ) │
│ io-user-sequences То же, что и pg_statio_all_sequences, за исключением того, что показываются только пользовательские │ │ последовательности.
│ последовательности. (Совместимо с PostgresSQL >= │ │
│ 11.0 ) │
│ io-user-tables Аналогично pg_statio_all_tables, за исключением того, что отображаются только пользовательские │ │ таблицы.
│ таблицы. (Совместимо с PostgresSQL >= 11.0 │
│ )                                                      │
│ sys-indexes Аналогично pg_stat_all_indexes, за исключением того, что показываются только индексы │ │ системных таблиц.
│ на системных таблицах. (Совместимо с │
│ PostgresSQL >= 11.0 ) │ │
│ пользовательские функции Одна строка для каждой отслеживаемой функции, показывающая статистику │
│ о выполнении этой функции. См.
│ pg_stat_user_functions для получения подробной информации. (Совместимо с │
│ PostgresSQL >= 11.0 ) │
│ user-tables То же, что и pg_stat_all_tables, за исключением того, что отображаются только пользовательские │
│ таблиц. (Совместимо с PostgresSQL >= 11.0 │
│ )                                                      │
│ xact-all-tables Аналогично pg_stat_all_tables, но подсчитывает действия, │
│ выполненные на данный момент в текущей транзакции (которые │
│ еще не включены в pg_stat_all_tables и связанные с ними │
│ представления). Колонки для количества живых и мертвых строк │
│ и действий по вакуумированию и анализу в этом │ │ представлении отсутствуют.
│ представлении. (Совместимо с PostgresSQL >= 11.0 ) │
│ xact-user-functions Аналогично pg_stat_user_functions, но учитывает только │ │ вызовы во время текущей транзакции (совместимо с PostgresSQL >= 11 0).
│ вызовы во время текущей транзакции (которые не │
│ еще не включены в pg_stat_user_functions). (Совместимо │
│ с PostgresSQL >= 11.0 ) │ │
│ xact-user-tables Аналогично pg_stat_xact_all_tables, за исключением того, что отображаются только пользовательские │ │ таблицы.
│ таблицы. (Совместимо с PostgresSQL >= 11.0 │
│ )                                                      │
╰─────────────────────────────────────────────────────────────────────────────╯

``` 
</div>

### Статистика PostgreSQL Server Stats Dinamic

<div class="termy">

```console
❯ pgperf server stats dinamic --help
                                                                               
 Использование: pgperf server stats dinamic [OPTIONS] COMMAND [ARGS]...                
                                                                               
 Представления динамической статистики                                                      
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│--verbose --no-verbose [по умолчанию: no-verbose] │
│ --debug --no-debug [по умолчанию: no-debug] │
│ --conf TEXT │
│ --help Вывести сообщение и выйти.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ активность Одна строка для каждого серверного процесса, показывающая информацию, связанную │
│ с текущей деятельностью этого процесса, например состояние │
│ и текущий запрос.  Подробности см. в разделе pg_stat_activity. ( │
│ >= PostgresSQL 11.0 ) │ │
│ progress-vacuum Одна строка для каждого бэкенда (включая рабочий autovacuum │
│ процессы), выполняющих VACUUM, показывая текущий прогресс. ( │
│ >= PostgresSQL 11.0 ) │ │
│ репликация Одна строка для каждого процесса-отправителя WAL, показывающая статистику о │
│ репликации на подключенный резервный сервер этого отправителя.   │
│ Подробности см. в разделе pg_stat_replication. ( >= PostgresSQL │
│ 11.0 ) │
│ ssl Одна строка для каждого соединения (обычного и репликации), показывающая │
│ информация о SSL, используемом в данном соединении. ( >= │
│ PostgresSQL 11.0 ) Подробности см. в pg_stat_ssl.          │
│ statements-reset pg_stat_statements_reset сбрасывает статистику, собранную до │
│ далеко с помощью pg_stat_statements ( >= PostgresSQL 11.0) │
│ подписка По крайней мере одна строка для каждой подписки, показывающая информацию │
│ о работниках подписки.  См.
│ pg_stat_subscription для получения подробной информации. ( >= PostgresSQL 11.0 │
│ )                                                         │
│ wal-receiver Только одна строка, показывающая статистику о приемнике WAL │
│ с подключенного сервера этого приемника. См.
│ pg_stat_wal_receiver для получения подробной информации. ( >= PostgresSQL 11.0 │ │
│ )                                                         │
╰─────────────────────────────────────────────────────────────────────────────╯

```
</div>

### Информация о таблице PostgreSQL
<div class="termy">

```console
❯ pgperf table --help
                                                                               
 Использование: pgperf table [OPTIONS] COMMAND [ARGS]...                               
                                                                               
 Информация о таблице                                                            
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --verbose --no-verbose [по умолчанию: no-verbose] │
│ --debug --no-debug [по умолчанию: no-debug] │
│ --conf TEXT │
│ --help Вывести сообщение и выйти.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ bloat Оценка «раздутого» пространства таблицы, выделенного для отношения │
│, которое заполнено мертвыми кортежами и которое еще предстоит освободить. │
│ cache-hit Вычисляет коэффициент попадания в кэш при чтении таблиц │
│ index-scans Количество сканирований индекса по таблице в порядке убывания │
│ index-size Общий размер всех индексов для каждой таблицы, в порядке убывания по │
│ размеру │
│ records-rank Все таблицы и количество строк в каждой из них, упорядоченные по │
│ количество строк по убыванию │
│ seq-scans Количество последовательных сканирований по таблице в порядке убывания │
│ size Размер таблиц (без учета индексов), в порядке убывания по размеру │
│ size-with-index Размер таблиц (включая индексы), убывающий по размеру │
╰─────────────────────────────────────────────────────────────────────────────╯

``` 
</div>

### Информация об индексах PostgreSQL
<div class="termy">

```console
❯ pgperf index --help
                                                                               
 Использование: pgperf index [OPTIONS] COMMAND [ARGS]...                               
                                                                               
 Информация об индексе                                                            
                                                                               
╭─ Options ───────────────────────────────────────────────────────────────────╮
│ --verbose --no-verbose [по умолчанию: no-verbose] │
│ --debug --no-debug [по умолчанию: no-debug] │
│ --conf TEXT │
│ --help Вывести сообщение и выйти.              │
╰─────────────────────────────────────────────────────────────────────────────╯
╭─ Commands ──────────────────────────────────────────────────────────────────╮
│ все Перечислите все индексы с соответствующими им таблицами и │
│ столбцами.                                                        │
│ cache-hit Рассчитывает коэффициент попадания в кэш при чтении индексов │
│ duplicate Показать несколько индексов, имеющих одинаковый набор столбцов, одинаковый │ │ opclass и предикат.
│ opclass, выражение и предикат.                              │
│ null Найти индексы с большим количеством значений NULL │
│ scans Количество сканирований, выполненных для индексов │
│ size Размер индексов, по убыванию размера, в МБ.                 │
│ total-size Общий размер всех индексов в МБ │
│ unused Неиспользуемые и почти неиспользуемые индексы. Упорядочены по их размеру │
│ относительно количества сканирований индекса. Исключите индексы очень │
│ небольших таблиц (менее 5 страниц), для которых планировщик почти │
│ неизменно выберет последовательное сканирование, но в будущем может этого не сделать │
│ по мере роста таблицы.
│ Использование Показатель попадания в индекс (эффективные базы данных составляют 99 % и выше)          │
╰─────────────────────────────────────────────────────────────────────────────╯

``` 
</div>
